Скрипты деплоя и управления инфраструктурой
Расположение: \\имя_домена.lan\dfs\Scripts

BackupTeamcityBase.ps1 скрипт создает бекап sql-базы Тимсити в папке C:\BackupBase\ с именем "текущее время.bak"

CodeSigning.ps1 скрипт подписывает пользовательские скрипты, используя в качестве удостоверяющего центра локальную машину, хранящую корневой сертификат.

Connection_mongo_ports.ps1 скрипт в в рабочем процессе осуществляет мониторинг, какие из исполняемых на серверах процессов 1xProjects и IIS устанавливают соединения к портам mongoDB 27017, 27019 для и сохраняет результаты в :\searchresult\mongo_ports\"текущая дата"\connections.txt

Get-BadConnection_all_ports_Sirius.ps1 legacy-скрипт для использования в старом ДЦ Sirius, услугами которого мы более не пользуемся. По назначению аналогичен следующему.

Get-BadConnection_mongo_ports.ps1 Скрипт в в рабочем процессе осуществляет мониторинг, какие из исполняемых на серверах процессов 1xProjects и IIS занимают своими соединениями порты mongoDB 27017, 27019, 27020, чего быть не должно для и сохраняет результаты в :\searchresult\mongo_ports\"текущая дата"\connections.txt

RestoreTeamcityBase.ps1 скрипт выбирает последний из файлов бекапа базы Тимсити и восстанавливает его

SwitchDBTeamCity.ps1 переключает сервер для хранения базы Teamcity между основным и резервным

Расположение: \имя_домена.lan\dfs\Scripts\Deploy

CopyFilesToStorage.ps1 скрипт принимает параметры из блока Param, в соответствии с типом разворачиваемого проекта (сайт, веб-сервис или консольное приложение) копирует файлы проекта в хранилище, формируя новый коммит

DeployOnServers.ps1 скрипт деплоит проект на сервера, при возникновении проблем в ходе развертывания (ошибки создания папки, копирования файлов, запуска проектов) - откатывает изменения. Разновидности проектов - консольный или windows-служба. Деплой сайта возможен в онлайн-режиме - без остановки сайта и пула,когда библиотеки подменяются на лету, или же в оффлайн.

ExeptionCatcher.ps1 выявляет по event log упавшие процессы. Обычные windows-службы, запускаемые как процессы, перезапускаются командлетом Restart-Service, а консольные проекты рестартуются c помощью задачи планировщика Windows. Скриптблок $jobrestart уведомляет пользователя в medium о проблеме, перезапускает процесс и снова уведомляет о результате.

Invoke-AbiitScripts.ps1

Remove-Project.ps1 скрипт запрашивает имя проекта и сервера, определяет тип (сайт, веб-сервис, консольное приложение или windows-служба) и удаляет его с указанной машины, соответствующим способом для каждого из типов

Restart-AppPools.ps1 cкрипт перезапускает пул приложений IIS, имя проекта и сайта запрашивается у пользователя, в кач-ве имени сервера принимает также "all"

RunAppInSession.ps1 скрипт принимает данные о проекте из скрипта deployonServer.ps1, удаляет прежние файлы проекта, записывает новые, предварительно размещенные в windows\temp. Все действия осуществляются путем использования задач планировщика задач windows.

StartProjects.ps1 скрипт принимает имя проекта и сервера, в качестве второго принимает local или all. Разворачивает проект скриптом DeployOnServers.ps1, при указании в качестве имени сервера "all", в зависимости от типа проекта определяет и передает в скрипт соответствующие проекту имена серверов

StopProject.ps1 cкрипт останавливает проект на сервере. Запрашивает имя проекта и сервер, после чего производит определяет тип проекта (консоль или windows-служба) и производит остановку соответствующим ему образом.

SyncPrivateFolder.ps1 скрипт сверяет хеши текущих файлов проекта с сохраненными в файле c:\scripts\Deploy\PrivateHashes.csv, помечает удаленные и добавленные

UpdateProdFirewall.ps1 скрипт запускается на контроллере домена и обновляет доменную политику, открывая на серверах порты в файрволле, требующиеся для работы проектов, в соответствии с информацией, хранящейся в гуглодоке.

Расположение: \\имя_домена.lan\dfs\Scripts\Servers

Check_WMF5.1.ps1 cкрипт проверяет наличие установки обновления KB2919355 для Windows 8.1 и RT 8.1. Ключевая особенность этого обновления заключается в том, что без его установки дальнейшее получение security-обновлений для этих ОС невозможно. Также, проверяет наличие обновления KB3191564, устанавливающего пакет Windows Management Framework (WMF) 5.1

ClearingVM.ps1 cкрипт принимает в аргументах имя ВМ. В соответствии со вводом, из хранилища виртуальных машин D:\EXPORT\копирует новый образ взамен имеющегося в рабочей папке D:\VHD, предусмотрена функция копирования в хранилище чистой виртуалки в хранилище после установки всех актуальных обновлений Windows. Все действия пишутся в лог D:\Script\log\clearvm-$имя_ВМ.txt

ConsulBackupRestore.ps1 cкрипт использовался для восстановления ключей и токенов consul из xml-файлов, забекапленных скриптом ConsulSyncAndBackup, в данный момент бекап и восстановление производится средствами consul с шифрованием, в настоящий момент восстановление для использования этих данных в работе невозможно, консул не принимает их в нешифрованном виде.

DeployStatus.ps1 cкрипт принимает имя сервера и переменную Status, которая может принимать один из 3 параметров Open - Разрешает деплой на выбранный сервер Close - Запрещает деплой на выбранный сервер и Test - Возвращает статус деплоя на выбранном сервере. Проверка завязана на ключ реестра HKLM:\Software\1xBet\Deploy\FalseDeployOnServers, устанавливаемый другими скриптами в 1 или 0.

ConsulSyncAndBackup.ps1 экпортирует ключи и токены consul в xml-файлы и сохраняет на диск, в данный момент бекап и восстановление производится средствами consul с шифрованием, так что обратное восстановление и корректный импорт данных в consul из xml невозможен.

CpuGuard.ps1 - скрипт определяет процесс, потребляющий наибольшее процессорное время и, если они имеют приоритет Realtime, high или abovenormal снижает ему приоритет до Below normal. Если приоритет задан Abovenormal, hightest или timecritical, снижает до Normal.

InitialProdServerSettings.ps1 скрипт для подготовки продакшен-сервера. Принимает имя сервера/серверов или All на вход. Устанавливает Microsoft Visual C++ Redistributable, запускает службу iscsi, тулзу WebDeploy_amd64_en-US.msi, включает CreedSSP, динамическую компрессию в IIS, дает права начтение и запись доменной группе Programmers на C:\inetpub\wwwroot, расширяет динамический диапазон клиентских портов для исходящих соединений от 15000 до 50535.

HostConfiguration.ps1 скрипт, подготавливающий диск, настраивающий team-интерфейс и вводящий сервер в домен.

Install-HotFix.ps1 скрипт принимает номер хотфикса и путь к папке с их расположением, проверяет наличие файлов хотфиксов на сервере в соотв. папке, устанавливает из нее недостающие в системе.

NetSettings.ps1 скрипт конфигурирует параметры адаптера, отключает не доменные интерфейсы, которые смотрят в интернет с белым IP все эти компоненты не нужны адаптеру в сети интернет, по факту нужен только протокол Ipv4 все остальное может представлять уязвимость если будет смотреть в интернет на прямую адаптеры с этими компонентами.

RDPSessions.ps1 скрипт отбирает доменнных пользователей, имеющих право на RDP-подключение на разные типы серверов, устанавливает данные подключения, чтобы запускались все необходимые сервисы, далее отключается от удаленного стола, сохраняя сессию активной.

Register-ScriptTasks.ps1 создает задачу в планировщике для автозапуска RDPSessions.ps1.

Remap_iis_logs_disk.ps1 скрипт демонтирует существующий рам-диск для логов IIS (L), создает новый объемом 4Гб, дает на него права на запись доменной группе Programmers, создает на нем папки по именам крутящийся на IIS сайтов. Для диска используется протокол iSCSI

Restart-ScriptTasks.ps1 скрипт контролирует состояние задач планировщика для серверов сети и перезапускает их при необходимости.

Rotate_IIS_LOGS.ps1 скрипт очищает рам-диск L: с логами IIS, если на нем осталось менее 750 Мб свободного места.

SincTeamcityUsers.ps1 скрипт добавляет в домен пользователей teamcity, если они отсутствуют там.

StringSearcher.ps1 скрипт с помощью вызова утилиты StringSearcher.exe ищет среди запущенных процессов введенный пользователем текст. Принимает имя сервера и строку для поиска, возвращает в виде таблицы имя процесса, PID, результат работы программы

UnlockVault.ps1 запрашивает ключи разблокировки сервера consul и его имя, проверяет, запущен ли он и залочен, после чего пробует разблокировать, используя введенные данные.

Up_to_WMF5.1.ps1 скрипт содержит функцию установки KB2919355 и WMF5.1, все ее тело переводится в массив байт и шифруется, после чего powershell запускается с данной последовательностью байт в качестве аргумента.

UpdateRoute.ps1 cкрипт принимает в качестве входных параметров параметры маршрутизации и обновляет или создает сетевой маршрут в соответствии с ними.

UpdateTimeZone.ps1 задает часовой пояс Russian Standard Time.

Variable Rack.ps1

ZabbixSender_winbackend.ps1 cкрипт запускает Заббикс и добавляет метрики для мониторинга счетчиков производительности IIS и сервисов 1х

ZabbixSender_WinInfrastructure.ps1 скрипт проверяет состояние vault для текущего сервера, выводит в Zabbix следующие метрики: состояние установка, инициализации, блокировки, статуса сервиса consul


Скрипты DSC
Расположение: \\имя_домена.lan\dfs\DSC\Configurations

CreateServerConfigurations.ps1 Скрипт определяет необходимый для каждого типа серверов (продакшен, билд, контроллер домена, сервер авторизации) набор конфигураций и вызывает создающие соответствующие mof-файлы скрипты. В дальнейшем, данные конфигурации применяются скриптом RunNewServerInstall.ps1 или RunSingle.ps1 Принимает на вход тип и список имен серверов для обработки.

RunNewServerInstall.ps1 Скрипт устанавливает на сервер, в зависимости от него назначения,несколько конфигураций из списка: LCMConfig", "WMF51", "Reboot", "WinFeatureProd", "Reboot", "WinFeatureProd", "ZabbixService", "ConsulAgent", "InitialProdServerSettings", "CustomProdSettings", "LogRamDisk", "InstallNetFramework". Далее выходит из Zabbix API.

RunSingle.ps1 скрипт применяет одну конфигурацию на один или несколько серверов, в качестве имени сервера принимает "all". Возможные варианты имени конфигурации вначале выводятся на экран

RunSinglequota.ps1 -скрипт аналогичен RunSingle.ps1, но добавлена команда для увеличения квоты на размер передаваемого файла конфигурации. Устраняет ошибку

The WinRM client sent a request to the remote WS-Management service and was notified that the request size exceeded the configured MaxEnvelopeSize quota, возникающую на некоторых серверах.

Расположение: \\wserv.lan\dfs\DSC\Configurations\other

WinFeatureGen.ps1 скрипт включает необходимые компоненты windows

Расположение: \\wserv.lan\dfs\DSC\Configurations\Features

ConsulAgent.ps1 скрипт устанавливет службу Сonsul-агент на сервер. При наличии ее на сервере, проверяет корректность текущей установки, если требуется, переустанавливает, обновляет конфиг.

CustomProdSettings.ps1 скрипт применяет конфигурацию, в которой добавляется резервирование URL-адресов для указанного пространства имен URL для учетных записей OU ServiceAccounts, а также импортирует сертификат в хранилище на локальном сервере. Принимает на вход список имен серверов для обработки, в том числе all.

InitialProdServerSettings.ps1 скрипт создает конфигурацию, подготавливающую продакшен-сервер к работе: добавляет резервирование TCP и UDP портов, включает аутентификацию CreedSSP, включает динамическую компрессию HTTP, устанавливает Web Deployment Tool и Visual C++ Redistributable, включает автозапуск службы iSCSI и устанаваливает региональные настройки для России. Принимает на вход список имен серверов для обработки, в том числе all.

InstallNetFramework.ps1 скрипт создает конфигурацию, проверяющую установленную на сервере версию NetFramework и обновляет ее до 4.7.1, если необходимо

LCMConfig.ps1 скрипт создает конфигурацию, включаеющую Local Configuration Manager на сервере(ах), чье имя передается в аргументах или, при их отсутствии, запрашивается у пользователя

LogRamDisk.ps1 скрипт создает конфигурацию, монтирующую RAM-диск L: для хранения логов IIS, используя протокол iSCSI

MonitoringService.ps1 скрипт создает конфигурацию, переустанавливающую службу Monitoring Service (Service Manager) и регистрирует ее в consul

PSWinUpdate.ps1 скрипт создает конфигурацию, устанавливающую все актуальные обновления windows с автоперезагрузкой сервера

WinFeatureADDS.ps1 скрипт создает конфигурацию, включающую на контроллере домена необходимые компоненты windows

WinFeatureADDS_CA.ps1 скрипт создает конфигурацию, включающую на контроллере домена, являющегося, также, удостоверяющим центром, необходимые компоненты windows

WinFeatureBase.ps1 скрипт создает конфигурацию, включающую на сервере компоненты windows, необходимые для удаленного подключения

WinFeatureProd.ps1 скрипт создает конфигурацию, включающую компоненты windows, необходимые для продакшен-сервера

WMF51.ps1 скрипт устанавливает обновление KB3191564 - Windows Management Framework 5.1

ZabbixService.ps1 скрипт создает конфигурацию, устанавливающую агент Zabbix на сервер. Принимает имя сервера, в т.ч. All и Renew. Агент и сервер используют PSK ключ для шифрования передаваемых между ними пакетов. Генерация производится в самом теле скрипта.


1xModule
Disable-WinUpdateNotification.ps1 функция блокирует вывод уведомлений о новых обновлениях Windows

Enable-WinUpdateNotification.ps1 функция разрешает вывод уведомлений о новых обновлениях Windows

Get-ProjectInfoObserver.ps1 скрипт проверяет работоспособность веб-проекта и его SSL-привязки путем выполнения запроса к утилите ServiceManager

Get-ProjectOnServersObserver.ps1 функция возвращает список серверов, на которых зарегистрирован сервис

Get-ProjectsObserver.ps1 функция возвращает список проектов, зарегистрированных на сервере Consul

Get-ProjectsToServerObserver.ps1 функция возвращает имена проектов, привязанных к серверу в Service Manager

Get-ServersObserver.ps1 функция возвращает список зарегистрированных в consul серверов с их IP

Import-1xClass.ps1 функция импортирует в скрипт, откуда она вызывается, класс, содержащий методы для записи логов

New-ScheduledTaskPath.ps1 функция возвращает путь к папке с задачей планировщика, чье имя передается в аргументах

Push-1xMessage.ps1 функция передает сообщение в Medium с использованием его API. В качестве адресатов могут выступать группы или отдельные люди

Register-ProjectToConsul.ps1 функция выполняет регистрацию проекта в consul на локальном или удаленном сервере, в аргументах передаются параметры, использование приведено в приммерах.

При регистрации указывается тип проверки работоспособности проекта Healthcheck - путем выполнения HTTP-запроса или же по TTL
Remove-Project.ps1 Restart-Project Cmdlet для перезапуска проекта на локальном или удаленном сервере.

Можно перезапускать:

- IIS AppPool; - IIS Site; - Console; - Windows Service

Set-DeployRuning.ps1 функция заносит в реестр ключи, показывающие статус деплоя и его время. Эти данные используются другими скриптами, связанными с деплоем

Start-Project.ps1 функция принимает во входных аргументах имена проектов и серверов для развертывания, в т.ч. AllServers и AllProjects, проверяет их готовность для развертывания и вызывает DeployOnServers.ps1 для выполнения деплоя

Stop-Project.ps1 функция принимает имя сервера и проекта, определяет, к какому из типов (консоль, win-служба, web-сервис, сайт) относится проект, проверяет, выполняется ли скрипт на локальном или удаленном сервере, и выполняет действия по остановке

Test-DeployServer.ps1 функция проверяет по ключу реестра "FalseDeployOnServers", было ли успешно проведено развертывание проекта на сервере. Создает ключ и выставляет его отрицательное значение, если ключ ранее не существовал\

Start-ReDeployProject.ps1

Unregister-ProjectToConsul.ps1 функция выполняет удаление регистрации проекта в consul на локальном или же удаленном сервере, принимает имя сервера и/или Powershell сессию к удаленной машине, имя определяется по ее свойству $PSSession.ComputerName

Write-Teamcity.ps1 функция выводит диагностические сообщения, получаемые в аргументах в окно консоли или TeamCity, в зависимости от значения аргумента RunScript